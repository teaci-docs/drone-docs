<!DOCTYPE html>
<html ng-app="app" lang="en">
	<head>
		<title>Secrets Â· Drone</title>

		<meta charset="utf-8" />
		<meta content="width=device-width, initial-scale=1" name="viewport" />
		<meta content="ie=edge" http-equiv="x-ua-compatible" />
		<meta name="Description" content="Documentation for the Drone Continuous Integration Server" />

		<link href="//fonts.googleapis.com/css?family=Roboto:400,300" rel="stylesheet" type="text/css">
		<link href="//fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet" type="text/css">
		<link href="//cdnjs.cloudflare.com/ajax/libs/octicons/3.3.0/octicons.css" rel="stylesheet">
		<link href="/style.css" rel="stylesheet">
		<link href="/prism.css" rel="stylesheet">
		<link href="/docs.css" rel="stylesheet">

	</head>
	<body>

<nav class="top-nav">
	<div class="container">
		<a href="http://docs.tea-ci.org/" class="brand"></a>
		<ul class="list-unstyled list-inline tabs">
			<li><a href="http://docs.tea-ci.org/usage/overview" class="current-item">Usage</a></li>
			
			<li><a href="http://docs.tea-ci.org/plugins">Plugins</a></li>
			<li><a href="http://docs.tea-ci.org/devs">Developers</a></li>
			<li><a href="http://docs.tea-ci.org/community/overview">Community</a></li>
			<li><a href="http://docs.tea-ci.org/setup/overview" >Installation</a></li>
		</ul>
	</div>
</nav>


		<main>
			<article class="grid-flex-container container">
					<div class="grid-flex-cell">
						<h1>Secrets</h1>
						<nav id="TableOfContents">
						
						<nav id="TableOfContents">
<ul>
<li><a href="#overview:0d943d142dc6bcdd2e544b095a49f72b">Overview</a></li>
<li><a href="#interpolation:0d943d142dc6bcdd2e544b095a49f72b">Interpolation</a></li>
<li><a href="#checksums:0d943d142dc6bcdd2e544b095a49f72b">Checksums</a></li>
<li><a href="#pull-requests:0d943d142dc6bcdd2e544b095a49f72b">Pull Requests</a></li>
<li><a href="#global-secrets:0d943d142dc6bcdd2e544b095a49f72b">Global Secrets</a></li>
<li><a href="#common-issues:0d943d142dc6bcdd2e544b095a49f72b">Common Issues</a></li>
</ul>
</nav>
						
						</nav>
						<section>

<blockquote>
<p>WARNING: drone does not prevent you from inadvertently exposing your secrets to the world. Please read this section of the documentation carefully to ensure you follow best practices and avoid exposing sensitive data.</p>
</blockquote>

<h1 id="overview:0d943d142dc6bcdd2e544b095a49f72b">Overview</h1>

<p>Drone lets you store secret variables in an encrypted <code>.drone.sec</code> file in the root of your repository. This is useful when your build requires sensitive information that should not be stored in plaintext in your yaml file. This document assumes you have installed the Drone <a href="/devs/cli">command line tools</a>.</p>

<p>Start with a plaintext YAML file that defines your secrets. For demonstration purposes let&rsquo;s assume this file is stored on disk and named <code>secrets.yml</code>. Secrets are defined in the <code>environment</code> section of this file:</p>

<pre><code class="language-yaml">---
environment:
  HEROKU_TOKEN: pa$$word
</code></pre>

<p>Reference secrets in your <code>.drone.yml</code> file using the <code>$$</code> notation:</p>

<pre><code class="language-yaml">---
deploy:
  heroku:
    app: petstore
    token: $$HEROKU_TOKEN
</code></pre>

<p>Encrypt the <code>secrets.yml</code> file and generate a <code>.drone.sec</code> file:</p>

<pre><code>drone secure --repo octocat/hello-world --in secrets.yml
</code></pre>

<p>Commit the encrypted <code>.drone.sec</code> file to the root of your repository:</p>

<pre><code>git add .drone.sec
git commit -m &quot;added .drone.sec file&quot;
</code></pre>

<h1 id="interpolation:0d943d142dc6bcdd2e544b095a49f72b">Interpolation</h1>

<p>Secrets are injected directly into the YAML at runtime using the <code>$$</code> notation:</p>

<pre><code class="language-yaml">---
deploy:
  heroku:
    app: foo
    token: $$HEROKU_TOKEN
</code></pre>

<p>Note that secrets are not automatically exposed to your build environment as
environment variables. For security purposes, you be must explicit when and
where to inject secrets.</p>

<p>This example demonstrates explicitly injecting a secret as an environment variable:</p>

<pre><code class="language-yaml">---
build:
  image: golang
  commands:
    - go build
    - go test
  environment:
    - PRIVATE_KEY=$$PRIVATE_KEY
</code></pre>

<p>Secrets that are multiple lines or contain special characters should be escaped to
avoid YAML parsing errors post-interpolation. You can escape strings by wrapping
the variable in quotes as shown below:</p>

<pre><code class="language-yaml">---
build:
  image: golang
  commands:
    - go build
    - go test
  environment:
    - PRIVATE_KEY=&quot;$$PRIVATE_KEY&quot;
</code></pre>

<h1 id="checksums:0d943d142dc6bcdd2e544b095a49f72b">Checksums</h1>

<p>Drone automatically calculates and stores a checksum of your <code>.drone.yml</code> file inside your <code>.drone.sec</code> file. Secrets are not injected into your build if the checksum cannot be verified. This means you must re-generate your <code>.drone.sec</code> file every time you <code>.drone.yml</code> changes (yes security is inconvenient).</p>

<p>Invalid checksums result in the following error at the top of your build logs:</p>

<pre><code>Unable to validate YAML checksum.
2ca66eb7be89f31afdebb197174abfa6dd14866ecbf9e552f44be5bd3244d08a
</code></pre>

<h1 id="pull-requests:0d943d142dc6bcdd2e544b095a49f72b">Pull Requests</h1>

<p>Drone injects secrets for all build types, including pull requests, as long as the checksum validation passes. You should avoid injecting secrets into the build section of the YAML and inadvertently exposing your secrets to malicious pull requests.</p>

<p><strong>This is bad</strong> because a malicious pull request could gain access to your secrets:</p>

<pre><code class="language-yaml">---
build:
  image: node
  environment:
    PASSWORD: $$PASSWORD
  commands:
    - npm install
    - npm run tests
    - npm run integration
</code></pre>

<p><strong>This is better</strong> because the build is split into sections. Secrets are injected into a section of the build that is not executed for pull requests:</p>

<pre><code class="language-yaml">---
build:
  unit_tests:
    image: node
    commands:
      - npm install
      - npm run tests

  integration_tests:
    image: node
    environment:
      PASSWORD: $$PASSWORD
    commands:
      - npm run integration
    when:
      event: push
</code></pre>

<h1 id="global-secrets:0d943d142dc6bcdd2e544b095a49f72b">Global Secrets</h1>

<p>Global secrets are stored in the <code>PLUGIN_PARAMS</code> environment variable declared in your Drone server configuration file. Global secrets are passed to every single build and should therefore only be used in trusted environments with trusted developers.</p>

<p>Example global secret declaration:</p>

<pre><code class="language-bash">PLUGIN_PARAMS=SMTP_PASSWORD=foo SLACK_TOKEN=bar
</code></pre>

<p>Example injecting global secrets into your <code>.drone.yml</code> file:</p>

<pre><code class="language-yaml">---
deploy:
  slack:
    channel: foo
    token: $$SLACK_TOKEN
</code></pre>

<h1 id="common-issues:0d943d142dc6bcdd2e544b095a49f72b">Common Issues</h1>

<p>Secrets are not injected into your build if the checksum cannot be validated. This happens when you change your <code>.drone.yml</code> file without re-generating a <code>.drone.sec</code> file resulting in the following error message at the top of your build logs:</p>

<pre><code>Unable to validate YAML checksum.
2ca66eb7be89f31afdebb197174abfa6dd14866ecbf9e552f44be5bd3244d08a
</code></pre>
</section>
					</div>

					<div class="grid-flex-cell grid-flex-cell-1of4">
						<nav role='navigation'>
							<ul class='list-unstyled side-nav'>
								
								
								<li>
									<a href="/usage/overview/" class="">Quick Start</a>
								</li>
								
								<li>
									<a href="/usage/variables/" class="">Variables</a>
								</li>
								
								<li>
									<a href="/usage/secrets/" class=" current-item">Secrets</a>
								</li>
								
								<li>
									<a href="/usage/cloning/" class="">Cloning</a>
								</li>
								
								<li>
									<a href="/usage/caching/" class="">Caching</a>
								</li>
								
								<li>
									<a href="/usage/services/" class="">Service Containers</a>
								</li>
								
								<li>
									<a href="/usage/build_test/" class="">Build &amp; Test</a>
								</li>
								
								<li>
									<a href="/usage/deploy/" class="">Deployments</a>
								</li>
								
								<li>
									<a href="/usage/notify/" class="">Notifications</a>
								</li>
								
								<li>
									<a href="/usage/matrix/" class="">Matrix</a>
								</li>
								
								<li>
									<a href="/usage/artifacts/" class="">Publishing Artifacts</a>
								</li>
								
							</ul>
						</nav>

						<div class="well">
This website is a <a href="https://github.com/drone/docs" target="_blank">public GitHub repository</a>. Please help us by forking the project and adding to it.
</div>

					</div>
			</article>
		</main>
		<script src="/prism.js"></script>
	</body>
</html>

